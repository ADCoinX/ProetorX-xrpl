<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>ProetorX Wallet Validator</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/px-logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .55rem;border-radius:999px;font-size:.85rem;font-weight:600}
    .badge.low{background:#0f5132;color:#d1f7e3;border:1px solid #198754}
    .badge.med{background:#664d03;color:#ffe8a1;border:1px solid #ffcd39}
    .badge.high{background:#842029;color:#ffd1d6;border:1px solid #dc3545}
    .flag-chip{display:inline-block;margin:.1rem .25rem 0 0;padding:.12rem .45rem;border-radius:.5rem;background:#2b2b2b;border:1px solid #3a3a3a;font-size:.8rem}
  </style>
</head>
<body>
  <header>
    <img src="/static/px-logo.png" alt="PX Logo" id="logo">
    <h1>ProetorX Wallet Validator</h1>
    <p class="subtitle">Verified First, Trusted Later</p>
  </header>

  <main>
    <section id="wallet-section" class="card">
      <form id="wallet-form" autocomplete="off">
        <label for="wallet" class="wallet-label">XRPL Wallet Address</label>
        <div class="input-row">
          <input type="text" id="wallet" name="wallet" placeholder="r..." spellcheck="false" autocapitalize="none" autocomplete="off">
          <button type="submit" id="validate-btn">Validate Wallet</button>
          <button type="button" id="iso-btn">Export ISO XML</button>
          <button type="button" id="rwa-btn" disabled>RWA Check (coming soon)</button>
        </div>
        <div id="form-result"></div>
      </form>
    </section>

    <section id="results-section" class="card">
      <h2>Validation Results</h2>
      <div id="risk-score">Risk Score: -</div>
      <div id="flags">Flags: -</div>
      <div id="balance">Balance: -</div>
      <div id="tx-count">Transactions: -</div>
      <div id="rwa-status">RWA: in-development</div>
    </section>

    <section id="metrics-section" class="card">
      <h2>Metrics Dashboard</h2>
      <div id="total-validations">Total Validations: -</div>
      <div id="avg-response-time">Avg Response Time: -</div>
      <div id="last-wallets"></div>
    </section>

    <section class="disclaimer">
      <h3>Disclaimer</h3>
      <p>
        This tool validates XRPL wallet addresses and provides a risk score based on public blockchain data.<br>
        <b>PX does NOT store private keys or sensitive wallet info.</b><br>
        All results are for informational purposes only and not financial advice. Always verify before trusting.
      </p>
    </section>
  </main>

  <footer>
    Powered by ADC CryptoGuard &bull; No sensitive data stored &bull; PX Wallet Validator © 2025
  </footer>

  <script>
    // ===== Helpers =====
    const fmtXRP = (v) => (v==null? "-" : (Number.isFinite(+v) ? `${(+v).toFixed(6)} XRP` : "-"));
    const fmtInt = (v) => (v==null? "-" : (Number.isFinite(+v) ? String(Math.trunc(+v)) : "-"));
    const isXRPLAddr = (a) => !!a && a[0]==="r" && a.length>=25 && a.length<=35;

    function riskBadge(score){
      if(score==null||isNaN(score)) return " -";
      const s = +score;
      if (s>60) return `${s} <span class="badge high">⛔ High Risk</span>`;
      if (s>20) return `${s} <span class="badge med">⚠️ Medium Risk</span>`;
      return `${s} <span class="badge low">✅ Low Risk</span>`;
    }

    function flagsChips(flags){
      if(flags==null||isNaN(flags)) return "-";
      const f = +flags, chips=[];
      if (f & 0x00020000) chips.push("DefaultRipple");
      if (f & 0x00010000) chips.push("RequireDestTag");
      if (f & 0x00080000) chips.push("DisallowXRP");
      if (f & 0x00400000) chips.push("GlobalFreeze");
      return chips.length ? `${f} ` + chips.map(c=>`<span class="flag-chip">${c}</span>`).join("") : String(f);
    }

    // ===== Submit: /validate =====
    document.getElementById('wallet-form').onsubmit = async (e)=>{
      e.preventDefault();
      const wallet = document.getElementById('wallet').value.trim();
      const result = document.getElementById('form-result');
      result.textContent = "";
      if(!isXRPLAddr(wallet)){
        result.innerHTML = '<span class="error">Invalid XRPL address. Must start with "r" and be ~25–35 chars.</span>';
        return;
      }
      document.getElementById('validate-btn').disabled = true;
      try{
        const res = await fetch('/validate', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({wallet})
        });
        if(!res.ok){
          let msg="Validation failed."; try{const e=await res.json(); msg=e.detail||msg;}catch{}
          result.innerHTML = `<span class="error">${msg}</span>`;
        }else{
          const data = await res.json();
          const riskVal = data.risk_score?.score ?? data.risk_score ?? null;
          const xrpl = data.xrpl || {};
          const balanceXrp = xrpl.balance_xrp ?? (xrpl.balance!==undefined ? (+xrpl.balance/1_000_000) : null);
          const flags = xrpl.flags ?? null;
          const txCount = xrpl.tx_count ?? xrpl.owner_count ?? null;

          document.getElementById('risk-score').innerHTML = "Risk Score: " + riskBadge(riskVal);
          document.getElementById('flags').innerHTML = "Flags: " + flagsChips(flags);
          document.getElementById('balance').innerText = "Balance: " + fmtXRP(balanceXrp);
          document.getElementById('tx-count').innerText = "Transactions: " + fmtInt(txCount);
          document.getElementById('rwa-status').innerText = "RWA: " + (data.rwa_status?.status ?? "in-development");

          result.innerHTML = '<span class="success">Wallet validated successfully.</span>';
          await updateMetrics();
        }
      }catch(ex){
        result.innerHTML = `<span class="error">Server error: ${ex.message}</span>`;
      }
      document.getElementById('validate-btn').disabled = false;
    };

    // ===== ISO export =====
    document.getElementById('iso-btn').onclick = async ()=>{
      const wallet = document.getElementById('wallet').value.trim();
      if(!isXRPLAddr(wallet)){ alert("Invalid wallet format for ISO export."); return; }
      try{
        const res = await fetch('/export_iso', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({wallet})
        });
        if(!res.ok){ try{const e=await res.json(); alert(e.detail||"Export failed");}catch{alert("Export failed");} return; }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=""; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }catch(e){ alert("Export failed: " + e.message); }
    };

    // ===== Metrics =====
    async function updateMetrics(){
      try{
        const res = await fetch('/metrics'); if(!res.ok) return;
        const m = await res.json();
        const total = m.total ?? m.total_validations ?? 0;
        const avgSec = (m.avg_response_ms!==undefined) ? (+m.avg_response_ms/1000) : (m.average_response_time ?? 0);
        document.getElementById('total-validations').innerText = "Total Validations: " + total;
        document.getElementById('avg-response-time').innerText = "Avg Response Time: " + (+avgSec).toFixed(2) + "s";
        const last = m.last ?? m.last_5_wallets ?? [];
        const listHtml = Array.isArray(last)&&last.length
          ? "<b>Last (anonymized if enabled):</b><ul>" + last.map(x=>{
              const w = x.addr ?? x.wallet ?? "-";
              const s = (x.score===0 || typeof x.score==="number") ? x.score : (x.score ?? "-");
              return `<li><code>${w}</code> – Score: <b>${s}</b></li>`;
            }).join("") + "</ul>"
          : "<b>Last:</b> <em>empty</em>";
        document.getElementById('last-wallets').innerHTML = listHtml;
      }catch{}
    }
    updateMetrics();

    // === Auto-validate from URL (?wallet=...) ===
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        const params = new URL(location.href).searchParams;
        const w = (params.get('wallet')||'').trim();
        if(w && isXRPLAddr(w)){
          document.getElementById('wallet').value = w;
          document.getElementById('wallet-form').dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
        }
      }catch{}
    });
  </script>
</body>
</html>
